# üóÑÔ∏è Database Design - Money Tracking App

## üìã T·ªïng Quan

Sau khi review to√†n b·ªô source code c·ªßa ·ª©ng d·ª•ng Money Tracking, t√¥i ƒë·ªÅ xu·∫•t thi·∫øt k·∫ø database PostgreSQL ho√†n ch·ªânh v·ªõi c√°c t√≠nh nƒÉng:

- ‚úÖ **Multi-user support**: H·ªó tr·ª£ nhi·ªÅu ng∆∞·ªùi d√πng
- ‚úÖ **Multiple wallets**: Nhi·ªÅu v√≠/t√†i kho·∫£n m·ªói user
- ‚úÖ **Categorized transactions**: Giao d·ªãch c√≥ danh m·ª•c
- ‚úÖ **Wallet transfers**: Chuy·ªÉn kho·∫£n gi·ªØa v√≠
- ‚úÖ **Auto balance calculation**: T·ª± ƒë·ªông t√≠nh s·ªë d∆∞
- ‚úÖ **User preferences**: C√†i ƒë·∫∑t c√° nh√¢n
- ‚úÖ **Analytics & reports**: B√°o c√°o ph√¢n t√≠ch

---

## üèóÔ∏è Core Database Tables

### 1. **USERS TABLE** üë•
Qu·∫£n l√Ω th√¥ng tin ng∆∞·ªùi d√πng v√† t√†i kho·∫£n.

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(255) NOT NULL,
    avatar_url VARCHAR(255),
    is_premium BOOLEAN DEFAULT FALSE,
    member_since TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Mapping t·ª´ UI:**
- Profile section trong `/account` page
- "Nguy·ªÖn VƒÉn A", "nguyenvana@example.com"
- Premium badge, "Th√†nh vi√™n t·ª´: Th√°ng 1, 2024"

---

### 2. **CATEGORIES TABLE** üè∑Ô∏è
Qu·∫£n l√Ω danh m·ª•c giao d·ªãch (default + custom).

```sql
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    icon VARCHAR(10) NOT NULL,
    color VARCHAR(20) NOT NULL,
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(user_id, name)
);
```

**Mapping t·ª´ UI:**
- Categories page: `/categories` v·ªõi CRUD functionality
- CategorySelect component v·ªõi 10 default categories
- M·ªói category c√≥: name, icon (emoji), color theme, transaction count

**Default Categories Seed Data:**
```sql
INSERT INTO categories (id, user_id, name, icon, color, is_default) VALUES
(uuid_generate_v4(), NULL, 'ƒÇn u·ªëng', 'üçî', 'orange', TRUE),
(uuid_generate_v4(), NULL, 'ƒêi l·∫°i', 'üöó', 'blue', TRUE),
(uuid_generate_v4(), NULL, 'Mua s·∫Øm', 'üõçÔ∏è', 'purple', TRUE),
(uuid_generate_v4(), NULL, 'Gi·∫£i tr√≠', 'üéÆ', 'green', TRUE),
(uuid_generate_v4(), NULL, 'Y t·∫ø', 'üè•', 'red', TRUE),
(uuid_generate_v4(), NULL, 'Ti·ªán √≠ch', '‚ö°', 'yellow', TRUE),
(uuid_generate_v4(), NULL, 'Gi√°o d·ª•c', 'üìö', 'indigo', TRUE),
(uuid_generate_v4(), NULL, 'Du l·ªãch', '‚úàÔ∏è', 'teal', TRUE),
(uuid_generate_v4(), NULL, 'Ti·∫øt ki·ªám', 'üí∞', 'emerald', TRUE),
(uuid_generate_v4(), NULL, 'Kh√°c', 'üì¶', 'gray', TRUE);
```

---

### 3. **WALLET_TYPES TABLE** üíº
Reference table cho c√°c lo·∫°i v√≠.

```sql
CREATE TABLE wallet_types (
    id VARCHAR(20) PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    icon VARCHAR(10) NOT NULL,
    description TEXT
);

INSERT INTO wallet_types (id, name, icon, description) VALUES
('cash', 'Ti·ªÅn m·∫∑t', 'üíµ', 'Ti·ªÅn m·∫∑t c·∫ßm tay'),
('bank', 'T√†i kho·∫£n ng√¢n h√†ng', 'üè¶', 'T√†i kho·∫£n ng√¢n h√†ng th√¥ng th∆∞·ªùng'),
('credit', 'Th·∫ª t√≠n d·ª•ng', 'üí≥', 'Th·∫ª t√≠n d·ª•ng v√† th·∫ª ghi n·ª£'),
('savings', 'T√†i kho·∫£n ti·∫øt ki·ªám', 'üí∞', 'T√†i kho·∫£n ti·∫øt ki·ªám c√≥ l√£i su·∫•t'),
('ewallet', 'V√≠ ƒëi·ªán t·ª≠', 'üì±', 'V√≠ ƒëi·ªán t·ª≠ (MoMo, ZaloPay, ...)'),
('investment', 'T√†i kho·∫£n ƒë·∫ßu t∆∞', 'üìà', 'T√†i kho·∫£n ƒë·∫ßu t∆∞ ch·ª©ng kho√°n');
```

**Mapping t·ª´ UI:**
- AddWalletForm component v·ªõi 6 wallet types
- M·ªói type c√≥ icon v√† description

---

### 4. **WALLETS TABLE** üëõ
Qu·∫£n l√Ω c√°c v√≠/t√†i kho·∫£n c·ªßa ng∆∞·ªùi d√πng.

```sql
CREATE TABLE wallets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    wallet_type VARCHAR(20) REFERENCES wallet_types(id),
    initial_balance DECIMAL(15,2) DEFAULT 0,
    current_balance DECIMAL(15,2) DEFAULT 0,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Mapping t·ª´ UI:**
- Wallet page v·ªõi 3 wallets: "V√≠ ch√≠nh" (1,250,000 VNƒê), "Th·∫ª t√≠n d·ª•ng" (5,000,000 VNƒê), "T√†i kho·∫£n ti·∫øt ki·ªám" (12,500,000 VNƒê)
- AddWalletForm: name, type, initialBalance, description
- ATM card design trong homepage v·ªõi balance: 6,250,000 VNƒê

---

### 5. **TRANSACTIONS TABLE** üí∏
Qu·∫£n l√Ω giao d·ªãch thu nh·∫≠p v√† chi ti√™u.

```sql
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    wallet_id UUID REFERENCES wallets(id) ON DELETE CASCADE,
    category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
    type VARCHAR(10) NOT NULL CHECK (type IN ('income', 'expense')),
    amount DECIMAL(15,2) NOT NULL CHECK (amount > 0),
    description TEXT,
    transaction_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Mapping t·ª´ UI:**
- Add page v·ªõi transaction type selection: 'expense' | 'income'
- Form fields: amount, category (CategorySelect), description
- Recent transactions trong homepage: "ƒÇn tr∆∞a" (-85,000), "XƒÉng xe" (-200,000), "L∆∞∆°ng th√°ng 12" (+15,000,000)

---

### 6. **TRANSFERS TABLE** üîÑ
Qu·∫£n l√Ω chuy·ªÉn kho·∫£n gi·ªØa c√°c v√≠.

```sql
CREATE TABLE transfers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    from_wallet_id UUID REFERENCES wallets(id) ON DELETE CASCADE,
    to_wallet_id UUID REFERENCES wallets(id) ON DELETE CASCADE,
    amount DECIMAL(15,2) NOT NULL CHECK (amount > 0),
    note TEXT,
    transfer_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CHECK (from_wallet_id != to_wallet_id)
);
```

**Mapping t·ª´ UI:**
- TransferForm component v·ªõi fromWallet, toWallet selection
- Swap functionality, amount input, note field
- Transfer validation: prevent self-transfer

---

### 7. **USER_SETTINGS TABLE** ‚öôÔ∏è
C√†i ƒë·∫∑t v√† preferences c·ªßa ng∆∞·ªùi d√πng.

```sql
CREATE TABLE user_settings (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    currency VARCHAR(10) DEFAULT 'VND',
    language VARCHAR(10) DEFAULT 'vi',
    timezone VARCHAR(50) DEFAULT 'Asia/Ho_Chi_Minh',
    notification_enabled BOOLEAN DEFAULT TRUE,
    email_notifications BOOLEAN DEFAULT TRUE,
    theme VARCHAR(20) DEFAULT 'light',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Mapping t·ª´ UI:**
- Account page v·ªõi settings menu: "C√†i ƒë·∫∑t chung", "Th√¥ng b√°o", "Tr·ª£ gi√∫p & H·ªó tr·ª£"
- Currency format: VNƒê throughout the app
- Vietnamese language interface

---

## üîß Advanced Features

### 1. **Auto Balance Update Triggers**
T·ª± ƒë·ªông c·∫≠p nh·∫≠t s·ªë d∆∞ v√≠ khi c√≥ transaction.

```sql
CREATE OR REPLACE FUNCTION update_wallet_balance()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        IF NEW.type = 'income' THEN
            UPDATE wallets
            SET current_balance = current_balance + NEW.amount,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = NEW.wallet_id;
        ELSIF NEW.type = 'expense' THEN
            UPDATE wallets
            SET current_balance = current_balance - NEW.amount,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = NEW.wallet_id;
        END IF;
        RETURN NEW;
    END IF;

    IF TG_OP = 'DELETE' THEN
        IF OLD.type = 'income' THEN
            UPDATE wallets
            SET current_balance = current_balance - OLD.amount,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = OLD.wallet_id;
        ELSIF OLD.type = 'expense' THEN
            UPDATE wallets
            SET current_balance = current_balance + OLD.amount,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = OLD.wallet_id;
        END IF;
        RETURN OLD;
    END IF;

    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER transaction_balance_trigger
    AFTER INSERT OR DELETE ON transactions
    FOR EACH ROW
    EXECUTE FUNCTION update_wallet_balance();
```

### 2. **Transfer Balance Update**
C·∫≠p nh·∫≠t s·ªë d∆∞ c·∫£ 2 v√≠ khi transfer.

```sql
CREATE OR REPLACE FUNCTION update_transfer_balances()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE wallets
        SET current_balance = current_balance - NEW.amount,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = NEW.from_wallet_id;

        UPDATE wallets
        SET current_balance = current_balance + NEW.amount,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = NEW.to_wallet_id;

        RETURN NEW;
    END IF;

    IF TG_OP = 'DELETE' THEN
        UPDATE wallets
        SET current_balance = current_balance + OLD.amount,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = OLD.from_wallet_id;

        UPDATE wallets
        SET current_balance = current_balance - OLD.amount,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = OLD.to_wallet_id;

        RETURN OLD;
    END IF;

    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER transfer_balance_trigger
    AFTER INSERT OR DELETE ON transfers
    FOR EACH ROW
    EXECUTE FUNCTION update_transfer_balances();
```

---

## üìä Analytics Views

### 1. **Monthly Summary View**
D√†nh cho Reports page - "T·ªïng quan th√°ng n√†y".

```sql
CREATE VIEW monthly_summary AS
SELECT
    user_id,
    DATE_TRUNC('month', transaction_date) as month,
    SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END) as total_income,
    SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) as total_expense,
    SUM(CASE WHEN type = 'income' THEN amount ELSE -amount END) as net_savings
FROM transactions
GROUP BY user_id, DATE_TRUNC('month', transaction_date);
```

**Mapping t·ª´ UI:**
- Reports page: Thu nh·∫≠p (+15,000,000), Chi ti√™u (-8,750,000), Ti·∫øt ki·ªám (+6,250,000)

### 2. **Category Spending View**
D√†nh cho Reports page - "Chi ti√™u theo danh m·ª•c".

```sql
CREATE VIEW category_spending AS
SELECT
    t.user_id,
    c.id as category_id,
    c.name as category_name,
    c.icon as category_icon,
    c.color as category_color,
    COUNT(t.id) as transaction_count,
    SUM(t.amount) as total_amount,
    ROUND(
        SUM(t.amount) * 100.0 / SUM(SUM(t.amount)) OVER (PARTITION BY t.user_id),
        1
    ) as percentage,
    DATE_TRUNC('month', t.transaction_date) as month
FROM transactions t
JOIN categories c ON t.category_id = c.id
WHERE t.type = 'expense'
GROUP BY t.user_id, c.id, c.name, c.icon, c.color, DATE_TRUNC('month', t.transaction_date);
```

**Mapping t·ª´ UI:**
- Reports page v·ªõi Progress bars:
  - üçî ƒÇn u·ªëng: 3,200,000 VNƒê (36.6%)
  - üõçÔ∏è Mua s·∫Øm: 2,800,000 VNƒê (32.0%)
  - üöó ƒêi l·∫°i: 1,500,000 VNƒê (17.1%)
  - üéÆ Gi·∫£i tr√≠: 1,250,000 VNƒê (14.3%)

### 3. **User Stats View**
D√†nh cho Account page statistics.

```sql
CREATE VIEW user_stats AS
SELECT
    u.id as user_id,
    COUNT(DISTINCT w.id) as wallet_count,
    COUNT(DISTINCT t.id) as transaction_count,
    CURRENT_DATE - u.member_since::date as days_since_joined
FROM users u
LEFT JOIN wallets w ON u.id = w.user_id AND w.is_active = TRUE
LEFT JOIN transactions t ON u.id = t.user_id
GROUP BY u.id, u.member_since;
```

**Mapping t·ª´ UI:**
- Account page quick stats: 152 giao d·ªãch, 3 v√≠, 68 ng√†y s·ª≠ d·ª•ng

---

## üöÄ Performance Optimization

### 1. **Essential Indexes**
```sql
-- User-specific queries
CREATE INDEX idx_wallets_user_id ON wallets(user_id);
CREATE INDEX idx_transactions_user_id ON transactions(user_id);
CREATE INDEX idx_transactions_wallet_id ON transactions(wallet_id);
CREATE INDEX idx_categories_user_id ON categories(user_id);
CREATE INDEX idx_transfers_user_id ON transfers(user_id);

-- Time-based queries (Reports)
CREATE INDEX idx_transactions_date ON transactions(transaction_date);
CREATE INDEX idx_transactions_type ON transactions(type);
CREATE INDEX idx_transactions_category_id ON transactions(category_id);

-- Composite indexes for complex queries
CREATE INDEX idx_transactions_user_type_date ON transactions(user_id, type, transaction_date);
CREATE INDEX idx_transactions_user_category_date ON transactions(user_id, category_id, transaction_date);
```

### 2. **Query Examples**

**L·∫•y total balance c·ªßa user:**
```sql
SELECT SUM(current_balance) as total_balance
FROM wallets
WHERE user_id = $1 AND is_active = TRUE;
```

**Recent transactions cho homepage:**
```sql
SELECT
    t.id,
    t.type,
    t.amount,
    t.description,
    t.transaction_date,
    c.name as category_name,
    c.icon as category_icon
FROM transactions t
LEFT JOIN categories c ON t.category_id = c.id
WHERE t.user_id = $1
ORDER BY t.transaction_date DESC
LIMIT 10;
```

**Monthly income/expense summary:**
```sql
SELECT
    type,
    SUM(amount) as total
FROM transactions
WHERE user_id = $1
AND DATE_TRUNC('month', transaction_date) = DATE_TRUNC('month', CURRENT_DATE)
GROUP BY type;
```

---

## üîó Data Relationships

```
USERS (1) -----> (M) WALLETS
USERS (1) -----> (M) TRANSACTIONS
USERS (1) -----> (M) TRANSFERS
USERS (1) -----> (M) CATEGORIES
USERS (1) -----> (1) USER_SETTINGS

WALLETS (1) -----> (M) TRANSACTIONS
WALLETS (1) -----> (M) TRANSFERS (as source)
WALLETS (1) -----> (M) TRANSFERS (as destination)
WALLET_TYPES (1) -----> (M) WALLETS

CATEGORIES (1) -----> (M) TRANSACTIONS
```

---

## üéØ Implementation Roadmap

### Phase 1: Core Setup
1. **Database Creation**: PostgreSQL database v·ªõi UUID extension
2. **Core Tables**: users, categories, wallet_types, wallets
3. **Basic CRUD**: User registration, wallet management
4. **Authentication**: NextAuth.js integration

### Phase 2: Transactions
1. **Transaction System**: transactions table v·ªõi triggers
2. **Category Management**: Dynamic categories v·ªõi UI
3. **Balance Calculation**: Auto-update triggers
4. **Transaction Forms**: Add/Edit/Delete operations

### Phase 3: Advanced Features
1. **Transfer System**: Wallet-to-wallet transfers
2. **Analytics**: Reports page v·ªõi views
3. **User Settings**: Preferences v√† customization
4. **Data Export**: CSV/PDF export functionality

### Phase 4: Optimization
1. **Performance**: Indexes v√† query optimization
2. **Security**: Row Level Security (RLS)
3. **Backup**: Database backup strategy
4. **Monitoring**: Query performance monitoring

---

## üîí Security Best Practices

1. **Row Level Security (RLS)**:
```sql
ALTER TABLE wallets ENABLE ROW LEVEL SECURITY;
CREATE POLICY user_wallets ON wallets FOR ALL TO authenticated USING (user_id = auth.uid());
```

2. **Input Validation**:
- Positive amounts only
- Valid email formats
- SQL injection prevention

3. **Authentication**:
- JWT tokens v·ªõi expiration
- Password hashing v·ªõi bcrypt
- Rate limiting cho login attempts

4. **Data Privacy**:
- User data isolation
- Secure password storage
- GDPR compliance ready

---

## üì¶ Technology Stack Recommendations

### Backend:
- **Database**: PostgreSQL 15+
- **ORM**: Prisma (type-safe) ho·∫∑c Drizzle (lightweight)
- **API**: Next.js API Routes
- **Auth**: NextAuth.js

### Frontend:
- **Framework**: Next.js 15 (ƒë√£ c√≥)
- **UI**: Shadcn UI (ƒë√£ c√≥)
- **State**: React hooks + Context API
- **Forms**: React Hook Form + Zod validation

### DevOps:
- **Hosting**: Vercel (frontend) + Supabase (database)
- **CI/CD**: GitHub Actions
- **Monitoring**: Sentry for error tracking
- **Analytics**: PostHog for user analytics

Schema n√†y ƒë∆∞·ª£c thi·∫øt k·∫ø d·ª±a tr√™n ph√¢n t√≠ch chi ti·∫øt UI/UX hi·ªán c√≥ v√† c√≥ th·ªÉ m·ªü r·ªông cho c√°c t√≠nh nƒÉng t∆∞∆°ng lai! üöÄ